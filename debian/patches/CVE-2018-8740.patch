From: Markus Koschany <apo@debian.org>
Date: Thu, 10 Jan 2019 12:08:24 +0100
Subject: CVE-2018-8740

Bug-Debian: https://bugs.debian.org/893195
Origin: https://www.sqlite.org/cgi/src/vdiff?from=1774f1c3baf0bc3d&to=d75e67654aa9620b
---
 src/build.c   | 6 ++++--
 src/prepare.c | 2 +-
 2 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/src/build.c b/src/build.c
index b897494..91ddc1b 100644
--- a/src/build.c
+++ b/src/build.c
@@ -1807,8 +1807,6 @@ void sqlite3EndTable(
   p = pParse->pNewTable;
   if( p==0 ) return;
 
-  assert( !db->init.busy || !pSelect );
-
   /* If the db->init.busy is 1 it means we are reading the SQL off the
   ** "sqlite_master" or "sqlite_temp_master" table on the disk.
   ** So do not write to the disk again.  Extract the root page number
@@ -1816,6 +1814,10 @@ void sqlite3EndTable(
   ** should have been put there by the sqliteOpenCb routine.)
   */
   if( db->init.busy ){
+    if( pSelect ){
+      sqlite3ErrorMsg(pParse, "");
+      return;
+    }
     p->tnum = db->init.newTnum;
   }
 
diff --git a/src/prepare.c b/src/prepare.c
index a05e619..40435f3 100644
--- a/src/prepare.c
+++ b/src/prepare.c
@@ -29,7 +29,7 @@ static void corruptSchema(
     if( zObj==0 ) zObj = "?";
     sqlite3SetString(pData->pzErrMsg, db,
       "malformed database schema (%s)", zObj);
-    if( zExtra ){
+    if( zExtra && zExtra[0] ){
       *pData->pzErrMsg = sqlite3MAppendf(db, *pData->pzErrMsg, 
                                  "%s - %s", *pData->pzErrMsg, zExtra);
     }
