From: Markus Koschany <apo@debian.org>
Date: Thu, 10 Jan 2019 12:25:03 +0100
Subject: CVE-2017-10989

Bug-Debian: https://bugs.debian.org/867618
Origin: https://sqlite.org/src/info/66de6f4a
---
 ext/rtree/rtree.c     |  4 ++++
 ext/rtree/rtreeA.test | 13 +++++++++++++
 2 files changed, 17 insertions(+)

diff --git a/ext/rtree/rtree.c b/ext/rtree/rtree.c
index 8150538..1984de8 100644
--- a/ext/rtree/rtree.c
+++ b/ext/rtree/rtree.c
@@ -3133,6 +3133,10 @@ static int getNodeSize(
     rc = getIntFromStmt(db, zSql, &pRtree->iNodeSize);
     if( rc!=SQLITE_OK ){
       *pzErr = sqlite3_mprintf("%s", sqlite3_errmsg(db));
+    }else if( pRtree->iNodeSize<(512-64) ){
+      rc = SQLITE_CORRUPT;
+      *pzErr = sqlite3_mprintf("undersize RTree blobs in \"%q_node\"",
+                               pRtree->zName);
     }
   }
 
diff --git a/ext/rtree/rtreeA.test b/ext/rtree/rtreeA.test
index e377b01..f7ff52b 100644
--- a/ext/rtree/rtreeA.test
+++ b/ext/rtree/rtreeA.test
@@ -216,5 +216,18 @@ do_corruption_tests rtreeA-6.1 {
   2   "UPDATE t1 SET x1=x1+1, x2=x2+1"
 }
 
+#-------------------------------------------------------------------------
+# Truncated blobs in the _node table.
+#
+create_t1
+populate_t1
+sqlite3 db test.db
+do_execsql_test rtreeA-7.100 { 
+  UPDATE t1_node SET data=x'' WHERE rowid=1;
+} {}
+do_catchsql_test rtreeA-7.110 {
+  SELECT * FROM t1 WHERE x1>0 AND x1<100 AND x2>0 AND x2<100;
+} {1 {undersize RTree blobs in "t1_node"}}
+
 
 finish_test
